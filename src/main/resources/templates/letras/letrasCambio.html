<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layoutSecretaria}">

<head>
    <meta charset="UTF-8">
    <title>Letras de Cambio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>

<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h4 class="text-center mb-4">Letras de Cambio del Contrato #[[${idContrato}]]</h4>

        <!-- Mensajes flash -->
        <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${mensaje}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Formulario (arriba) -->
        <div class="card shadow-lg rounded-4 border-0 bg-white mb-4">
            <div class="card-body p-4">
                <h5 class="mb-3">Generar Letras de Cambio</h5>
                <form th:action="@{/letras/contrato/{idContrato}(idContrato=${idContrato})}" method="post" novalidate>
                    <input type="hidden" name="idContrato" th:value="${idContrato}" />

                    <div class="row mb-3 g-3">
                        <div class="col-12 col-md-4">
                            <label for="idDistrito" class="form-label fw-semibold">Distrito de Giro:</label>
                            <select class="form-select" id="idDistrito" name="idDistrito" required>
                                <option value="">-- Selecciona Distrito --</option>
                                <option th:each="d : ${listaDistritos}" th:value="${d.idDistrito}"
                                        th:text="${d.nombre}"></option>
                            </select>
                            <div class="invalid-feedback">
                                Debes seleccionar un distrito.
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="fechaGiro" class="form-label fw-semibold">Fecha de Giro:</label>
                            <input type="date" class="form-control" id="fechaGiro" name="fechaGiro" required>
                            <div class="invalid-feedback">
                                Fecha de giro requerida.
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="fechaVencimientoInicial" class="form-label fw-semibold">Fecha del Primer Vencimiento:</label>
                            <input type="date" class="form-control" id="fechaVencimientoInicial"
                                   name="fechaVencimientoInicial" required>
                            <div class="invalid-feedback">
                                Fecha de vencimiento requerida.
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 g-3">
                        <div class="col-md-4">
                            <label for="importe" class="form-label fw-semibold">Importe por Letra:</label>
                            <input type="text" class="form-control" id="importe" name="importe" required>
                            <div class="invalid-feedback">
                                Importe requerido.
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label for="importeLetras" class="form-label fw-semibold">Importe en Letras:</label>
                            <input type="text" class="form-control" id="importeLetras" name="importeLetras" required readonly
                                   aria-readonly="true">
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">Generar Letras</button>
                        <a th:href="@{/contrato/lista}" class="btn btn-secondary flex-fill">Volver</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de letras (abajo) -->
        <div class="card shadow rounded-4">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tablaLetras" class="table table-striped table-bordered">
                        <thead class="table-primary text-center">
                        <tr>
                            <th>#</th>
                            <th>NÃºmero Letra</th>
                            <th>Estado</th>
                            <th>Fecha Giro</th>
                            <th>Fecha Vencimiento</th>
                            <th>Importe</th>
                            <th>Importe Texto</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="letra, iter : ${listaLetras}">
                            <td th:text="${iter.count}"></td>
                            <td th:text="${letra.numeroLetra}"></td>
                            <td th:text="${letra.estado}"></td>
                            <td th:text="${#dates.format(letra.fechaGiro, 'dd/MM/yyyy')}"></td>
                            <td th:text="${#dates.format(letra.fechaVencimiento, 'dd/MM/yyyy')}"></td>
                            <td th:text="'$ ' + ${#numbers.formatDecimal(letra.importe, 1, 'POINT', 2, 'COMMA')}"></td>
                            <td th:text="${letra.importeLetras}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(listaLetras)}">
                            <td colspan="7" class="text-center text-muted">No hay letras registradas para este contrato.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Scripts -->
<div layout:fragment="scripts">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script th:src="@{/js/convertirNumeroALetras.js}"></script>
	<script th:src="@{/js/letraCambio.js}"></script>
    
</div>
</body>
</html>
